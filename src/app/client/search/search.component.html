<!-- search.component.html -->
<div class="container mt-4">
  <div class="row">
    <div class="col-md-10">
      <h3 class="mb-4">Search</h3>
      <div class="row">
        <div class="col-12">
          <app-date-picker [initialFromDate]="initialFromDate" [initialToDate]="today"
                           (dateRangeChange)="dateRangeChange($event)"></app-date-picker>
        </div>
      </div>

      <!-- Search Form -->
      <form (ngSubmit)="onSearchSubmit()" class="mb-4">
        <!-- Search Input -->
        <div class="input-group input-group-lg">
          <input type="text"
                 class="form-control"
                 placeholder="Search counselings, clients and tasks..."
                 [ngModel]="searchTerm()"
                 (ngModelChange)="onSearchInput($event)"
                 name="search"
                 [disabled]="isLoading()">
          <button class="btn btn-primary"
                  type="submit"
                  [disabled]="isLoading() || searchTerm().trim().length === 0">
            @if (!isLoading()) {
              <span>
                <i class="bi bi-search"></i> Search
              </span>
            }
            @if (isLoading()) {
              <span>
                <span class="spinner-border spinner-border-sm me-2"></span>
                Searching...
              </span>
            }
          </button>
          @if (searchTerm().length > 0 || startDate() || endDate()) {
            <button class="btn btn-outline-secondary"
                    type="button"
                    (click)="clearSearch()">
              <i class="bi bi-x-lg"></i> Clear
            </button>
          }
        </div>
      </form>

      <!-- Error Message -->
      @if (error()) {
        <div class="alert alert-danger">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          {{ error() }}
        </div>
      }

      <!-- Loading Indicator -->
      @if (isLoading() && !searchResults()) {
        <div class="text-center my-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3 text-muted">Searching...</p>
        </div>
      }

      <!-- Search Results -->
      @if (searchResults() && !isLoading()) {
        <div>

          <!-- Results Summary -->
          <div class="alert alert-success mb-4">
            <fa-icon [icon]="faCircleLeft"></fa-icon>
            Found <strong>{{ searchResults().pagination.totalElements }}</strong> results
            ({{ searchResults().pagination.totalCounselings }} counselings,
            {{ searchResults().pagination.totalClients }} clients, {{ searchResults().pagination.totalTasks }} tasks)
            @if (startDate() || endDate()) {
              <span>
              <br>
              <small>
                <fa-icon [icon]="faCalendarAlt"></fa-icon>
              &nbsp;  Filtered by date:
                @if (startDate()) {
                  <span>
                    from {{ startDate().day + '.' + startDate().month + '.' + startDate().year }}
                  </span>
                }
                @if (endDate()) {
                  <span> to {{ endDate().day + '.' + endDate().month + '.' + endDate().year }}</span>
                }
              </small>
            </span>
            }
          </div>

          <!-- No Results -->
          @if (searchResults().totalResults === 0) {
            <div class="alert alert-warning">
              <i class="bi bi-search me-2"></i>
              No results found for "<strong>{{ searchTerm }}</strong>". Try different keywords.
            </div>
          }

          <!-- Counselings Results -->
          @if (searchResults().counselings.length > 0) {
            <div class="mb-4">
              <h4 class="mb-3">
                <i class="bi bi-journal-text me-2"></i>
                Counselings
              </h4>
              <div class="list-group mb-4">
                @for (counseling of searchResults().counselings; track counseling) {
                  <div class="list-group-item list-group-item-action">
                    <div>
                      <div class="d-flex w-100 justify-content-between">
                        <p class="mb-1">
                          @if (counseling.concern) {
                            <b>Anliegen:</b><br>
                            <span
                              [innerHTML]="counseling.concern | truncateAround:searchTerm():150 | highlight:searchTerm()">
                      </span>
                          }
                        </p>
                        <small class="text-muted">ID: {{ counseling.id }}</small>
                      </div>
                      @if (counseling.activity) {
                        <b>Aktivit√§t:</b>
                        <div class="d-flex w-100 justify-content-between">
                          <p class="mb-1"
                             [innerHTML]="counseling.activity | truncateAround:searchTerm():150 | highlight:searchTerm()">
                          </p>
                        </div>
                      }
                    </div>
                    <div class="row">
                      <div class="col-md-2">
                        <a [routerLink]="['/clients/', counseling.clientId]">
                          <small class="badge bg-primary">Counseling</small>
                        </a>
                      </div>
                    </div>
                  </div>
                }
              </div>
            </div>
          }

          <!-- Clients Results -->
          @if (searchResults().clients.length > 0) {
            <div class="mb-4">
              <h4 class="mb-3">
                <i class="bi bi-person-fill me-2"></i>
                Clients
              </h4>
              <div class="list-group mb-4">
                @for (client of searchResults().clients; track client) {
                  <div class="list-group-item list-group-item-action">
                    <div class="d-flex w-100 justify-content-between">
                      <p class="mb-1">
                        @if (client.firstName && client.lastName) {
                          <b>Name:</b><br>
                          <span [innerHTML]="client.firstName + ' ' + client.lastName | highlight:searchTerm()"></span>
                        }
                      </p>
                      <small class="text-muted">ID: {{ client.id }}</small>
                    </div>
                    @if (client.keyword) {
                      <p class="mb-1">
                        <b>Keyword:</b><br>
                        <span [innerHTML]="client.keyword | highlight:searchTerm()"></span>
                      </p>
                    }
                    @if (client.comment) {
                      <b>Kommentar:</b>
                      <p class="mb-1" [innerHTML]="client.comment | highlight:searchTerm()"></p>
                    }
                    <a [routerLink]="['/clients/', client.id]">
                      <small class="badge bg-success">Client</small>
                    </a>
                  </div>
                }
              </div>
            </div>
          }

          <!-- Tasks Results -->
          @if (searchResults().tasks.length > 0) {
            <div class="mb-4">
              <h4 class="mb-3">
                <i class="bi bi-person-fill me-2"></i>
                Tasks
              </h4>
              <div class="list-group mb-4">
                @for (task of searchResults().tasks; track task) {
                  <div class="list-group-item list-group-item-action">
                    <div class="d-flex w-100 justify-content-between">
                      <p class="mb-1">
                        @if (task.title) {
                          <b>Title:</b>

                          <p class="mb-1" [innerHTML]="task.title | highlight:searchTerm()"></p>

                        }
                      </p>
                      <small class="text-muted">ID: {{ task.id }}</small>
                    </div>
                    @if (task.description) {
                      <b>Description:</b>
                      <div class="d-flex w-100 justify-content-between">
                        <p class="mb-1"
                           [innerHTML]="task.description | truncateAround:searchTerm():150 | highlight:searchTerm()"></p>
                      </div>
                    }
                    @if (task.clientId) {
                      <p class="mb-1">
                        <a [routerLink]="['/clients/', task.clientId]">
                          <span class="badge bg-warning text-dark me-2">Task</span>
                        </a>
                      </p>
                    }
                  </div>
                }
              </div>
            </div>
          }

          <!-- Pagination -->
          @if (searchResults().pagination.totalPages > 1) {
            <nav aria-label="Search results pagination">
              <ul class="pagination justify-content-center">
                <li class="page-item" [class.disabled]="!searchResults().pagination.hasPrevious">
                  <a class="page-link" (click)="previousPage()" tabindex="-1">
                    <i class="bi bi-chevron-left"></i> Previous
                  </a>
                </li>

                @for (pageNum of pageNumbers(); track pageNum) {
                  <li class="page-item"
                      [class.active]="pageNum === currentPage()">
                    <a class="page-link" (click)="goToPage(pageNum)">
                      {{ pageNum + 1 }}
                    </a>
                  </li>
                } @empty {
                  <li class="page-item disabled">
                    <span class="page-link">No pages</span>
                  </li>
                }

                <li class="page-item" [class.disabled]="!searchResults().pagination.hasNext">
                  <a class="page-link" (click)="nextPage()">
                    Next <i class="bi bi-chevron-right"></i>
                  </a>
                </li>
              </ul>

              <p class="text-center text-muted small">
                Page {{ currentPage() + 1 }} of {{ searchResults().pagination.totalPages }}
              </p>
            </nav>
          }
        </div>
      }
      @if (!searchResults()) {
        <div>
          <div style="height: 200px"></div>
        </div>
      }
    </div>
  </div>

</div>

