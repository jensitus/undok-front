<!-- search.component.html -->
<div class="container mt-4">
  <div class="row">
    <div class="col-md-10">
      <h3 class="mb-4">Search</h3>
      <div class="row">
        <div class="col-12">
          <app-date-picker [initialFromDate]="initialFromDate" [initialToDate]="today"
                           (dateRangeChange)="dateRangeChange($event)"></app-date-picker>
        </div>
      </div>

      <!-- Search Form -->
      <form (ngSubmit)="onSearchSubmit()" class="mb-4">
        <!-- Search Input -->
        <div class="input-group input-group-lg">
          <input type="text"
                 class="form-control"
                 placeholder="Search counselings and clients..."
                 [(ngModel)]="searchTerm"
                 (ngModelChange)="onSearchInput()"
                 name="search"
                 [disabled]="isLoading">
          <button class="btn btn-primary"
                  type="submit"
                  [disabled]="isLoading || searchTerm.trim().length === 0">
            <span *ngIf="!isLoading">
              <i class="bi bi-search"></i> Search
            </span>
            <span *ngIf="isLoading">
              <span class="spinner-border spinner-border-sm me-2"></span>
              Searching...
            </span>
          </button>
          <button class="btn btn-outline-secondary"
                  type="button"
                  (click)="clearSearch()"
                  *ngIf="searchTerm.length > 0 || startDate || endDate">
            <i class="bi bi-x-lg"></i> Clear
          </button>
        </div>
      </form>

      <!-- Error Message -->
      <div class="alert alert-danger" *ngIf="error">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        {{ error }}
      </div>

      <!-- Loading Indicator -->
      <div class="text-center my-5" *ngIf="isLoading && !searchResults">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Searching...</p>
      </div>

      <!-- Search Results -->
      <div *ngIf="searchResults && !isLoading">

        <!-- Results Summary -->
        <div class="alert alert-success mb-4">
          <fa-icon [icon]="faCircleLeft"></fa-icon>
          Found <strong>{{ searchResults.pagination.totalElements }}</strong> results
          ({{ searchResults.pagination.totalCounselings }} counselings,
          {{ searchResults.pagination.totalClients }} clients, {{ searchResults.pagination.totalTasks }} tasks)
          <span *ngIf="startDate || endDate">
            <br>
            <small>
              <fa-icon [icon]="faCalendarAlt"></fa-icon>
              &nbsp;Filtered by date:
              <span *ngIf="startDate">from {{ startDate.day + '.' + startDate.month + '.' + startDate.year }}</span>
              <span *ngIf="endDate"> to {{ endDate.day + '.' + endDate.month + '.' + endDate.year }}</span>
            </small>
          </span>
        </div>

        <!-- No Results -->
        <div class="alert alert-warning" *ngIf="searchResults.totalResults === 0">
          <i class="bi bi-search me-2"></i>
          No results found for "<strong>{{ searchTerm }}</strong>". Try different keywords.
        </div>

        <!-- Counselings Results -->
        <div *ngIf="searchResults.counselings.length > 0" class="mb-4">
          <h4 class="mb-3">
            <i class="bi bi-journal-text me-2"></i>
            Counselings
          </h4>
          <div class="list-group mb-4">
            <div *ngFor="let counseling of searchResults.counselings"
                 class="list-group-item list-group-item-action">
              <div>
                <div class="d-flex w-100 justify-content-between">
                  <p class="mb-1">
                @if (counseling.concern) {
                  <b>Anliegen:</b><br>
                      <span [innerHTML]="counseling.concern | truncateAround:searchTerm:150 | highlight:searchTerm">
                      </span>
                }
                  </p>
                  <small class="text-muted">ID: {{ counseling.id }}</small>
                </div>
                @if (counseling.activity) {
                  <b>Aktivit√§t:</b>
                  <div class="d-flex w-100 justify-content-between">
                    <p class="mb-1"
                       [innerHTML]="counseling.activity | truncateAround:searchTerm:150 | highlight:searchTerm">
                    </p>
                  </div>
                }
              </div>
              <div class="row">
                <div class="col-md-2">
                  <a [routerLink]="['/clients/', counseling.clientId]">
                    <small class="badge bg-primary">Counseling</small>
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Clients Results -->
        <div *ngIf="searchResults.clients.length > 0" class="mb-4">
          <h4 class="mb-3">
            <i class="bi bi-person-fill me-2"></i>
            Clients
          </h4>
          <div class="list-group mb-4">
            <div *ngFor="let client of searchResults.clients"
                 class="list-group-item list-group-item-action">
              <div class="d-flex w-100 justify-content-between">
                <p class="mb-1">
                  @if (client.firstName && client.lastName) {
                    <b>Name:</b><br>
                    <span [innerHTML]="client.firstName + ' ' + client.lastName | highlight:searchTerm"></span>
                  }
                </p>
                <small class="text-muted">ID: {{ client.id }}</small>
              </div>
              <p class="mb-1" *ngIf="client.keyword">
                <b>Keyword:</b><br>
                <span [innerHTML]="client.keyword | highlight:searchTerm"></span>
              </p>
              @if (client.comment) {
                <b>Kommentar:</b>
                <p class="mb-1" [innerHTML]="client.comment | highlight:searchTerm"></p>
              }
              <a [routerLink]="['/clients/', client.id]">
                <small class="badge bg-success">Client</small>
              </a>
            </div>
          </div>
        </div>

        <!-- Tasks Results -->
        <div *ngIf="searchResults.tasks.length > 0" class="mb-4">
          <h4 class="mb-3">
            <i class="bi bi-person-fill me-2"></i>
            Tasks
          </h4>
          <div class="list-group mb-4">
            <div *ngFor="let task of searchResults.tasks"
                 class="list-group-item list-group-item-action">
              <div class="d-flex w-100 justify-content-between">
                <p class="mb-1">
              @if (task.title) {
                <b>Title:</b>

                  <p class="mb-1" [innerHTML]="task.title | highlight:searchTerm"></p>

              }
                </p>
                <small class="text-muted">ID: {{ task.id }}</small>
              </div>
              @if (task.description) {
                <b>Description:</b>
                <div class="d-flex w-100 justify-content-between">
                  <p class="mb-1"
                     [innerHTML]="task.description | truncateAround:searchTerm:150 | highlight:searchTerm"></p>
                </div>
              }
              <p class="mb-1" *ngIf="task.clientId">
                <a [routerLink]="['/clients/', task.clientId]">
                  <span class="badge bg-warning text-dark me-2">Task</span>
                </a>
              </p>
            </div>
          </div>
        </div>

        <!-- Pagination -->
        <nav aria-label="Search results pagination" *ngIf="searchResults.pagination.totalPages > 1">
          <ul class="pagination justify-content-center">
            <li class="page-item" [class.disabled]="!searchResults.pagination.hasPrevious">
              <a class="page-link" (click)="previousPage()" tabindex="-1">
                <i class="bi bi-chevron-left"></i> Previous
              </a>
            </li>

            <li
              *ngFor="let pageNum of getPageNumbers()"
              class="page-item"
              [class.active]="pageNum === currentPage">
              <a class="page-link" (click)="goToPage(pageNum)">
                {{ pageNum + 1 }}
              </a>
            </li>

            <li class="page-item" [class.disabled]="!searchResults.pagination.hasNext">
              <a class="page-link" (click)="nextPage()">
                Next <i class="bi bi-chevron-right"></i>
              </a>
            </li>
          </ul>

          <p class="text-center text-muted small">
            Page {{ currentPage + 1 }} of {{ searchResults.pagination.totalPages }}
          </p>
        </nav>
      </div>
      <div *ngIf="!searchResults">
        <div style="height: 200px"></div>
      </div>
    </div>
  </div>

</div>

